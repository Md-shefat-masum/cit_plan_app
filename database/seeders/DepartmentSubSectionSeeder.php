<?php

namespace Database\Seeders;

use App\Models\TaskManagement\DepartmentSection;
use App\Models\TaskManagement\DepartmentSubSection;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;

class DepartmentSubSectionSeeder extends Seeder
{
    use WithoutModelEvents;

    /**
     * Run the database seeds.
     * Pattern: each row (object), key = parent (department_section), value = child (sub_section).
     * Aggregate: for each parent, collect all unique non-empty values as children.
     */
    public function run(): void
    {
        DB::statement('SET FOREIGN_KEY_CHECKS=0;');

        DepartmentSubSection::truncate();

        DB::statement('SET FOREIGN_KEY_CHECKS=1;');

        $raw = '[{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"ডেভেলপমেন্ট","মোবাইল অ্যাপ ডেভেলপমেন্ট":"ডেভেলপমেন্ট","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"ডেভেলপমেন্ট","প্রজেক্ট ম্যানেজমেন্ট":"রিভিউ","আইটি ট্রেনিং":"ক্র্যাশ কোর্স","টেক ম্যাটারিয়ালস":"ডকুমেন্টস","টেক সোশ্যাল প্লাটফর্ম":"ওয়েবসাইট","টেকনিক্যাল সাপোর্ট":"ডকুমেন্টেশন","সার্ভিসিং":"ডিভাইস সার্ভিসিং","পারচেজ":"ডিভাইস","ডিজাইন প্রোডাকশন":"অনলাইন পোস্টার","ভিডিও প্রোডাকশন":"আর্কাইভ ভিডিও","UI/UX প্রোডাকশন":"ডিজাইন","অনলাইন লাইব্রেরি":"সফট কপি","সার্ভার ম্যানেজমেন্ট":"ডকুমেন্টেশন","সিকিউরিটি":"সাইবার টিম","রিসার্চ এন্ড ডেভেলপমেন্ট":"রিসার্চ","টেক টিম":"অবকাঠামো","ডাটা প্রসেসিং":"ডাটা কালেকশন","ডিজিটাল মার্কেটিং":"ওয়েবসাইট SEO","টেক ক্যারিয়ার":"ডকুমেন্টেশন","ইনভেন্টরি":"টিম","ডিজিটাল কন্টেন্ট":"আপডেট","অ্যানিমেশন":"কন্টেন্ট তৈরি","রিপোর্ট সফটওয়্যার":"কন্টেন্ট","প্রশিক্ষণ সাইট":"আইটিউব","শহীদ সাইট":"আর্টিকেল","আইটিউব":"সম্পদ","আর্টিকেল":"তত্ত্বাবধান","অর্থ":"অফিস ব্যবস্থাপনা","শাখা তত্ত্বাবধান":"ব্যাকআপ","অফিস ব্যবস্থাপনা":"রিপোর্টিং","ব্যাকআপ":"স্প্রিচুয়াল ট্রেনিং","রিপোর্টিং":"রেডিও শিবির","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"আপডেট","মোবাইল অ্যাপ ডেভেলপমেন্ট":"আপডেট","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"আপডেট","প্রজেক্ট ম্যানেজমেন্ট":"প্রপোজাল","আইটি ট্রেনিং":"মাস্টার কোর্স","টেক ম্যাটারিয়ালস":"টিপস-ট্রিক্স","টেক সোশ্যাল প্লাটফর্ম":"ফেসবুক পেইজ","টেকনিক্যাল সাপোর্ট":"এক্সেল/শীট","সার্ভিসিং":"অনলাইন সার্ভিস","পারচেজ":"এক্সেসরিজ","ডিজাইন প্রোডাকশন":"ক্যাম্পেইন স্টিকার","ভিডিও প্রোডাকশন":"প্রমো ভিডিও","UI/UX প্রোডাকশন":"লাইব্রেরি ১ সাইট","অনলাইন লাইব্রেরি":"পর্যালোচনা","সার্ভার ম্যানেজমেন্ট":"সিকিউরিটি স্টেপ","সিকিউরিটি":"ডেভেলপমেন্ট","রিসার্চ এন্ড ডেভেলপমেন্ট":"প্রোগ্রাম/কর্মসূচি","টেক টিম":"ডাটা সাপ্লাই","ডাটা প্রসেসিং":"Youtube SEO","ডিজিটাল মার্কেটিং":"ক্যারিয়ার গঠন","টেক ক্যারিয়ার":"কন্টেন্ট তৈরি","ইনভেন্টরি":"সফর","ডিজিটাল কন্টেন্ট":"শিশু সাইট","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","মোবাইল অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","প্রজেক্ট ম্যানেজমেন্ট":"ডেভেলপমেন্ট","আইটি ট্রেনিং":"বিশেষ কোর্স","টেক ম্যাটারিয়ালস":"প্রেজেন্টেশন","টেক সোশ্যাল প্লাটফর্ম":"ফেসবুক গ্রুপ","টেকনিক্যাল সাপোর্ট":"গুগল ফর্ম","সার্ভিসিং":"সার্ভিস টু দ্যা ডোর","পারচেজ":"অনলাইন","ডিজাইন প্রোডাকশন":"ক্রেস্ট/সার্টিফিকেট","ভিডিও প্রোডাকশন":"লিরিক্যাল ভিডিও","UI/UX প্রোডাকশন":"লাইব্রেরি ২ সাইট","অনলাইন লাইব্রেরি":"ম্যানেজমেন্ট","সার্ভার ম্যানেজমেন্ট":"তথ্য সংরক্ষণ","সিকিউরিটি":"ওয়ার্কশপ","রিসার্চ এন্ড ডেভেলপমেন্ট":"ডাটা অ্যানালাইসিস","টেক টিম":"সোশ্যাল মিডিয়া অডিট","ডাটা প্রসেসিং":"আউটপুট","ডিজিটাল মার্কেটিং":"শাখা টিম","টেক ক্যারিয়ার":"শিক্ষা সাইট","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"ট্রায়াল","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"অন্যান্য কোর্স","প্রজেক্ট ম্যানেজমেন্ট":"ভিডিও","আইটি ট্রেনিং":"টেলিগ্রাম চ্যানেল","টেক ম্যাটারিয়ালস":"গুগল শিট","টেক সোশ্যাল প্লাটফর্ম":"সোশ্যাল মিডিয়া সাপোর্ট","টেকনিক্যাল সাপোর্ট":"ব্যানার","সার্ভিসিং":"ভিডিও এডিটিং","পারচেজ":"অডিও বুক","ডিজাইন প্রোডাকশন":"সাপোর্ট","ভিডিও প্রোডাকশন":"টিম ওয়ার্ক","UI/UX প্রোডাকশন":"পেইড মার্কেটিং","অনলাইন লাইব্রেরি":"প্রশিক্ষণ","সার্ভার ম্যানেজমেন্ট":"আইসিটি সেন্টার","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"পর্যবেক্ষণ","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"ওয়ার্কশপ","প্রজেক্ট ম্যানেজমেন্ট":"সফটওয়্যার","আইটি ট্রেনিং":"হোয়াটসঅ্যাপ চ্যানেল","টেক ম্যাটারিয়ালস":"রিপোর্টিং","টেক সোশ্যাল প্লাটফর্ম":"টাইপোগ্রাফি/লোগো","টেকনিক্যাল সাপোর্ট":"ভিডিও বুক","সার্ভিসিং":"ডকুমেন্টেশন","পারচেজ":"ট্রেইনার","ডিজাইন প্রোডাকশন":"রিটার্গেটিং মার্কেটিং","ভিডিও প্রোডাকশন":"ওয়ার্কশপ","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"ট্রেনিং আউটলাইন","প্রজেক্ট ম্যানেজমেন্ট":"তথ্যপ্রযুক্তি বই","আইটি ট্রেনিং":"ইউটিউব চ্যানেল","টেক ম্যাটারিয়ালস":"প্রেজেন্টেশন","টেক সোশ্যাল প্লাটফর্ম":"ফটো এডিট","টেকনিক্যাল সাপোর্ট":"ভিডিও মেকিং","সার্ভিসিং":"প্রশিক্ষণ","পারচেজ":"মেন্টরিং টিম","ডিজাইন প্রোডাকশন":"ডকুমেন্টেশন","ভিডিও প্রোডাকশন":"প্রশিক্ষণ","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"সফটওয়্যার","প্রজেক্ট ম্যানেজমেন্ট":"প্রোফাইল ফটো/কভার","আইটি ট্রেনিং":"কেন্দ্রীয় টিম","টেক ম্যাটারিয়ালস":"রিসার্চ এন্ড ডেভেলপমেন্ট","টেক সোশ্যাল প্লাটফর্ম":"প্রশিক্ষণ","টেকনিক্যাল সাপোর্ট":"","সার্ভিসিং":"","পারচেজ":"","ডিজাইন প্রোডাকশন":"","ভিডিও প্রোডাকশন":"","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"ভিডিও কন্টেন্ট","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"ব্রডকাস্টিং","প্রজেক্ট ম্যানেজমেন্ট":"কেন্দ্রীয় টিম","আইটি ট্রেনিং":"ডকুমেন্টারি","টেক ম্যাটারিয়ালস":"সিএসই টিম","টেক সোশ্যাল প্লাটফর্ম":"কেন্দ্রীয় টিম","টেকনিক্যাল সাপোর্ট":"","সার্ভিসিং":"","পারচেজ":"","ডিজাইন প্রোডাকশন":"","ভিডিও প্রোডাকশন":"","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"আঞ্চলিক ওয়ার্কশপ","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"প্রোগ্রাম বাস্তবায়ন","প্রজেক্ট ম্যানেজমেন্ট":"কন্টেন্ট স্ট্র্যাটেজি","আইটি ট্রেনিং":"বিশেষ টিম","টেক ম্যাটারিয়ালস":"","টেক সোশ্যাল প্লাটফর্ম":"","টেকনিক্যাল সাপোর্ট":"","সার্ভিসিং":"","পারচেজ":"","ডিজাইন প্রোডাকশন":"","ভিডিও প্রোডাকশন":"","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""},{"ওয়েব অ্যাপ ডেভেলপমেন্ট":"","মোবাইল অ্যাপ ডেভেলপমেন্ট":"অন্যান্য","ডেস্কটপ অ্যাপ ডেভেলপমেন্ট":"","প্রজেক্ট ম্যানেজমেন্ট":"","আইটি ট্রেনিং":"","টেক ম্যাটারিয়ালস":"","টেক সোশ্যাল প্লাটফর্ম":"","টেকনিক্যাল সাপোর্ট":"","সার্ভিসিং":"","পারচেজ":"","ডিজাইন প্রোডাকশন":"","ভিডিও প্রোডাকশন":"","UI/UX প্রোডাকশন":"","অনলাইন লাইব্রেরি":"","সার্ভার ম্যানেজমেন্ট":"","সিকিউরিটি":"","রিসার্চ এন্ড ডেভেলপমেন্ট":"","টেক টিম":"","ডাটা প্রসেসিং":"","ডিজিটাল মার্কেটিং":"","টেক ক্যারিয়ার":"","ইনভেন্টরি":"","ডিজিটাল কন্টেন্ট":"","অ্যানিমেশন":"","রিপোর্ট সফটওয়্যার":"","প্রশিক্ষণ সাইট":"","শহীদ সাইট":"","আইটিউব":"","আর্টিকেল":"","অর্থ":"","শাখা তত্ত্বাবধান":"","অফিস ব্যবস্থাপনা":"","ব্যাকআপ":"","রিপোর্টিং":"","স্প্রিচুয়াল ট্রেনিং":"","বাসা":"","বিশেষ প্রজেক্ট":"","অন্যান্য":""}]';

        $rows = json_decode($raw, true);
        if (!$rows) {
            $this->command->error('Failed to parse JSON');
            return;
        }

        // parent (key) -> [unique non-empty children (values)]
        $parentChildren = [];

        foreach ($rows as $row) {
            foreach ($row as $parent => $child) {
                $parent = trim(str_replace("\t", '', $parent));
                $child = is_string($child) ? trim($child) : '';
                if ($child !== '') {
                    if (!isset($parentChildren[$parent])) {
                        $parentChildren[$parent] = [];
                    }
                    if (!in_array($child, $parentChildren[$parent], true)) {
                        $parentChildren[$parent][] = $child;
                    }
                }
            }
        }

        // Build format: [ { department_section, department_id, department_section_id, sub_section: [] }, ... ]
        $sectionsByTitle = DepartmentSection::all()->keyBy(function ($s) {
            return trim($s->title);
        });

        $sectionIndex = 1;
        $result = [];

        foreach ($parentChildren as $departmentSectionTitle => $subSectionTitles) {
            $section = $sectionsByTitle->get($departmentSectionTitle);
            $departmentId = $section ? $section->department_id : 1;
            $departmentSectionId = $section ? $section->id : $sectionIndex;

            $result[] = [
                'department_section' => $departmentSectionTitle,
                'department_id' => $departmentId,
                'department_section_id' => $departmentSectionId,
                'sub_section' => $subSectionTitles,
            ];

            $sectionIndex++;
        }

        // Seed DepartmentSubSection for each child
        foreach ($result as $group) {
            foreach ($group['sub_section'] as $title) {
                DepartmentSubSection::create([
                    'department_id' => $group['department_id'],
                    'department_section_id' => $group['department_section_id'],
                    'title' => $title,
                    'slug' => uniqid(),
                    'status' => 1,
                    'creator' => 0,
                ]);
            }
        }

        $this->command->info('Department sub section seeding completed! ' . array_sum(array_map(fn ($r) => count($r['sub_section']), $result)) . ' records created.');
    }
}
